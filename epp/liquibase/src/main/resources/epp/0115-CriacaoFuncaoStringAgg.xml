<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <changeSet id="verifica_permissao_clr" author="jovan" dbms="mssql" >
        <preConditions onFailMessage="O recurso de integração CLR não está ativado. Favor habilitar o recurso: https://msdn.microsoft.com/pt-br/library/ms131048(v=sql.110).aspx">
            <sqlCheck expectedResult="1">SELECT CAST(value as varchar(255)) FROM sys.configurations where name = 'show advanced options';</sqlCheck>

            <sqlCheck expectedResult="1">SELECT CAST(value as varchar(255)) FROM sys.configurations where name = 'clr enabled';</sqlCheck>
        </preConditions>
    </changeSet>
    
    <changeSet id="1" author="victorpasqualino" dbms="mssql">
    	
    	<!-- A referência desse arquivo é 'scripts/StringUtil.cs' -->
    	<sql>
    		
			CREATE ASSEMBLY [StringUtils]
			AUTHORIZATION dbo
			FROM 0x4d5a90000300000004000000ffff0000b800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000e1fba0e00b409cd21b8014ccd21546869732070726f6772616d2063616e6e6f742062652072756e20696e20444f53206d6f64652e0d0d0a2400000000000000504500004c010300000000000000000000000000e00002210b0108000008000000060000000000000e270000002000000040000000004000002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000c02600004b00000000400000f002000000000000000000000000000000000000006000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002e7465787400000014070000002000000008000000020000000000000000000000000000200000602e72737263000000f00200000040000000040000000a0000000000000000000000000000400000402e72656c6f6300000c0000000060000000020000000e00000000000000000000000000004000004200000000000000000000000000000000f02600000000000048000000020005005c2100005805000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e02280f00000a2a3202730200000a7d010000042a0000001330030078000000000000000f01280300000a39010000002a0f02280300000a390c0000007201000070280400000a1002027b010000046f0500000a3a1e000000027b010000040f01fe16040000016f0600000a6f0700000a263824000000027b01000004048c040000010f01fe16040000016f0600000a280800000a6f0700000a262a4e027b01000004037b010000046f0900000a262a46027b010000046f0600000a730a00000a2a8e033a0b0000007205000070730b00000a7a02036f0c00000a730d00000a7d010000042a8e033a0b0000007209000070730b00000a7a03027b010000046f0600000a6f0e00000a2a000042534a4201000100000000000c00000076342e302e33303331390000000005006c000000e4010000237e0000500200000402000023537472696e6773000000005404000010000000235553006404000010000000234755494400000074040000e400000023426c6f620000000000000002000010571700000900000000fa013300160000010000000b0000000200000001000000070000000500000001000000100000000200000001000000020000000000f3010100000000000600290037000a00430064000a00850064000a009c00a6000600dd00e4000600fb00e40006001101e40006002701340106004b0134010a00830164000600a001be010000000001000000000001000100012010000a00000015000100010001001600010050200000000086187f006d00010058200000000086005e016d000100682000000000860063019a000100ec200000000086006e01a200030000210000000086007401a8000400122100000000e6017e01ad000400362100000000e6015801b3000500000001008c00000002009200000001000901000001000f010000010049010200290011007f00050009007f006d002100bb0071002100c60075000900d2007b002900eb007f000900f40083003100020189000900f4008f0021007f00950039007f00950041003e017f0009007f00950049005801950029007f006d0059007f006d002e008300b90043000b000b0004800000000000000000000000000000000094010000040000000000000000000000d800de0100000000040000000000000000000000d800e7010000000000000000003c4d6f64756c653e00436f6e636174656e61746500496e7465726d656469617465526573756c7400537472696e674275696c6465720053797374656d2e546578740053716c55736572446566696e6564416767726567617465417474726962757465004d6963726f736f66742e53716c5365727665722e536572766572002e63746f7200466f726d61740076616c75650064656c696d697465720053716c537472696e670053797374656d2e446174612e53716c5479706573006765745f49734e756c6c006f705f496d706c69636974006765745f4c656e677468004f626a6563740053797374656d00546f537472696e6700417070656e6400537472696e6700436f6e636174006f74686572007200417267756d656e744e756c6c457863657074696f6e0042696e6172795265616465720053797374656d2e494f0052656164537472696e6700770042696e61727957726974657200577269746500496e697400416363756d756c617465004d65726765005465726d696e6174650052656164004942696e61727953657269616c697a6500537472696e675574696c730052756e74696d65436f6d7061746962696c6974794174747269627574650053797374656d2e52756e74696d652e436f6d70696c65725365727669636573006d73636f726c69620053797374656d2e4461746100537472696e675574696c732e646c6c000000032c00000372000003770000000000ba8b861d0dd77f4194e81ae104108f05000306120505200101110d6101000200000004005402124973496e76617269616e74546f4e756c6c73015402174973496e76617269616e74546f4475706c696361746573005402124973496e76617269616e74546f4f726465720054080b4d61784279746553697a65401f0000032000010320000205000111110e032000080320000e05200112050e0500020e1c1c05200112051c042001010e072002011111111105200101120804200011110520010112210520010112251e01000100540216577261704e6f6e457863657074696f6e5468726f77730108b77a5c561934e089000000000000000000000000000000e82600000000000000000000fe260000002000000000000000000000000000000000000000000000f02600000000000000005f436f72446c6c4d61696e006d73636f7265652e646c6c0000000000ff2500204000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000980200000000000000000000980234000000560053005f00560045005200530049004f004e005f0049004e0046004f0000000000bd04effe00000100000000000000000000000000000000003f000000000000000400000002000000000000000000000000000000440000000100560061007200460069006c00650049006e0066006f00000000002400040000005400720061006e0073006c006100740069006f006e00000000007f00b004f8010000010053007400720069006e006700460069006c00650049006e0066006f000000d401000001003000300037006600300034006200300000001c000200010043006f006d006d0065006e007400730000002000000024000200010043006f006d00700061006e0079004e0061006d00650000000000200000002c0002000100460069006c0065004400650073006300720069007000740069006f006e000000000020000000300008000100460069006c006500560065007200730069006f006e000000000030002e0030002e0030002e003000000038000c00010049006e007400650072006e0061006c004e0061006d006500000053007400720069006e0067005500740069006c00730000002800020001004c006500670061006c0043006f0070007900720069006700680074000000200000002c00020001004c006500670061006c00540072006100640065006d00610072006b00730000000000200000004800100001004f0072006900670069006e0061006c00460069006c0065006e0061006d006500000053007400720069006e0067005500740069006c0073002e0064006c006c000000240002000100500072006f0064007500630074004e0061006d0065000000000020000000280002000100500072006f006400750063007400560065007200730069006f006e000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000c000000103700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
			WITH PERMISSION_SET = SAFE;
			
			CREATE AGGREGATE [dbo].[string_agg](@value NVARCHAR(4000), @delimiter NVARCHAR(255))
			RETURNS NVARCHAR(4000)  
			EXTERNAL NAME [StringUtils].[Concatenate];
			
    	</sql>
    
    </changeSet>
    
    <changeSet id="2" author="victorpasqualino" dbms="postgresql">
    	<createProcedure>
    		CREATE OR REPLACE FUNCTION concat_ws_ext(agg_state text, value text, separator text, repeated boolean)
			returns text
			immutable
			language plpgsql
			as $$
			declare
			  temp_result text;
			begin
			  if repeat then
			    temp_result := concat_ws(separator, agg_state, value);
			  else
			  	if strpos(agg_state, value) is not null and strpos(agg_state, value) &gt; 0 then
			      --contains value ignore
			      temp_result := agg_state;
			    else
			      temp_result := concat_ws(separator, agg_state, value);
			    end if;
			  end if;
			  return temp_result;
			end;
			$$;
			
			CREATE AGGREGATE string_agg_ext ( value text, separator text, repeated boolean) (
			    SFUNC = concat_ws_ext,
			    STYPE = text
			)
    	</createProcedure>
    </changeSet>
    
    <changeSet id="2" author="victorpasqualino" dbms="mssql">
    	<!-- A referência desse arquivo é 'scripts/StringUtil.cs' no caso o .dll -->
    	<sql>
    		drop AGGREGATE [dbo].[string_agg];
			drop assembly [StringUtils];
			
			CREATE ASSEMBLY [StringUtils]
			AUTHORIZATION dbo
			FROM 0x4d5a90000300000004000000ffff0000b800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000e1fba0e00b409cd21b8014ccd21546869732070726f6772616d2063616e6e6f742062652072756e20696e20444f53206d6f64652e0d0d0a2400000000000000504500004c010300000000000000000000000000e00002210b0108000008000000060000000000009e270000002000000040000000004000002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000502700004b00000000400000f002000000000000000000000000000000000000006000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002e74657874000000a4070000002000000008000000020000000000000000000000000000200000602e72737263000000f00200000040000000040000000a0000000000000000000000000000400000402e72656c6f6300000c0000000060000000020000000e0000000000000000000000000000400000420000000000000000000000000000000080270000000000004800000002000500b42100009c05000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e02281100000a2a3202730200000a7d010000042a00000013300300cf000000000000000f01280300000a39010000002a0f02280300000a390c0000007201000070280400000a1002027b010000046f0500000a3a1e000000027b010000040f01fe16040000016f0600000a6f0700000a26387b0000000f03280800000a394b000000027b010000046f0600000a0f01fe16040000016f0600000a6f0900000a3a24000000027b01000004048c040000010f01fe16040000016f0600000a280a00000a6f0700000a263824000000027b01000004048c040000010f01fe16040000016f0600000a280a00000a6f0700000a262a4e027b01000004037b010000046f0b00000a262a46027b010000046f0600000a730c00000a2a8e033a0b0000007205000070730d00000a7a02036f0e00000a730f00000a7d010000042a8e033a0b0000007209000070730d00000a7a03027b010000046f0600000a6f1000000a2a00000042534a4201000100000000000c00000076342e302e33303331390000000005006c000000fc010000237e0000680200002c02000023537472696e677300000000940400001000000023555300a4040000100000002347554944000000b4040000e800000023426c6f620000000000000002000010571700000900000000fa013300160000010000000c00000002000000010000000700000006000000010000001200000002000000010000000200000000001c020100000000000600290037000a00430064000a00850064000a00a500af000600e600ed000a000401af0006001b01ed0006003a01ed00060050015d01060074015d010a00ac0164000600c901e7010000000001000000000001000100012010000a00000015000100010001001600010050200000000086187f006d000100582000000000860087016d00010068200000000086008c019f00010043210000000086009701a900040057210000000086009d01af000500692100000000e601a701b40005008d2100000000e6018101ba000600000001008c00000002009200000003009c0000000100320100000100380100000100720102002d0011007f00050009007f006d002100c40071002100cf0075000900db007b002900f4007f000900fd00830031000f01710039002201890039002b018e000900fd00940021007f009a0041007f009a00490067017f0009007f009a00510081019a0029007f006d0061007f006d002e009300c00043000b000b00048000000000000000000000000000000000bd010000040000000000000000000000df00070200000000040000000000000000000000df0010020000000000000000003c4d6f64756c653e00436f6e636174656e61746500496e7465726d656469617465526573756c7400537472696e674275696c6465720053797374656d2e546578740053716c55736572446566696e6564416767726567617465417474726962757465004d6963726f736f66742e53716c5365727665722e536572766572002e63746f7200466f726d61740076616c75650064656c696d697465720072657065617465640053716c537472696e670053797374656d2e446174612e53716c5479706573006765745f49734e756c6c006f705f496d706c69636974006765745f4c656e677468004f626a6563740053797374656d00546f537472696e6700417070656e640053716c426f6f6c65616e006765745f497346616c736500537472696e6700436f6e7461696e7300436f6e636174006f74686572007200417267756d656e744e756c6c457863657074696f6e0042696e6172795265616465720053797374656d2e494f0052656164537472696e6700770042696e61727957726974657200577269746500496e697400416363756d756c617465004d65726765005465726d696e6174650052656164004942696e61727953657269616c697a6500537472696e675574696c730052756e74696d65436f6d7061746962696c6974794174747269627574650053797374656d2e52756e74696d652e436f6d70696c65725365727669636573006d73636f726c69620053797374656d2e4461746100537472696e675574696c732e646c6c0000032c00000372000003770000000000ba83143360887145bb421db048817145000306120505200101110d6101000200000004005402124973496e76617269616e74546f4e756c6c73015402174973496e76617269616e74546f4475706c696361746573005402124973496e76617269616e74546f4f726465720054080b4d61784279746553697a65ffffffff032000010320000205000111110e032000080320000e05200112050e042001020e0500020e1c1c05200112051c042001010e0920030111111111111905200101120804200011110520010112250520010112291e01000100540216577261704e6f6e457863657074696f6e5468726f77730108b77a5c561934e0897827000000000000000000008e270000002000000000000000000000000000000000000000000000802700000000000000005f436f72446c6c4d61696e006d73636f7265652e646c6c0000000000ff2500204000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000980200000000000000000000980234000000560053005f00560045005200530049004f004e005f0049004e0046004f0000000000bd04effe00000100000000000000000000000000000000003f000000000000000400000002000000000000000000000000000000440000000100560061007200460069006c00650049006e0066006f00000000002400040000005400720061006e0073006c006100740069006f006e00000000007f00b004f8010000010053007400720069006e006700460069006c00650049006e0066006f000000d401000001003000300037006600300034006200300000001c000200010043006f006d006d0065006e007400730000002000000024000200010043006f006d00700061006e0079004e0061006d00650000000000200000002c0002000100460069006c0065004400650073006300720069007000740069006f006e000000000020000000300008000100460069006c006500560065007200730069006f006e000000000030002e0030002e0030002e003000000038000c00010049006e007400650072006e0061006c004e0061006d006500000053007400720069006e0067005500740069006c00730000002800020001004c006500670061006c0043006f0070007900720069006700680074000000200000002c00020001004c006500670061006c00540072006100640065006d00610072006b00730000000000200000004800100001004f0072006900670069006e0061006c00460069006c0065006e0061006d006500000053007400720069006e0067005500740069006c0073002e0064006c006c000000240002000100500072006f0064007500630074004e0061006d0065000000000020000000280002000100500072006f006400750063007400560065007200730069006f006e000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000c000000a03700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
			WITH PERMISSION_SET = SAFE;
			
			CREATE AGGREGATE [dbo].[string_agg](@value NVARCHAR(4000), @delimiter NVARCHAR(255), @repeated BIT)
			RETURNS NVARCHAR(MAX)  
			EXTERNAL NAME [StringUtils].[Concatenate];
    	</sql>
    </changeSet>
    
</databaseChangeLog>

